module.exports = function(cb,opts,t) {
    var memdb = require('memdb')
    var blastLevel = require('../../index.js')
    var db = memdb({valueEncoding: 'json'})

    // create temporary dir for blast db storage
    // and always clean it up after
    var tmp = require('tmp')
    tmp.setGracefulCleanup()
    var tmpDir = tmp.dirSync({
        unsafeCleanup: true
    })

    var xtend = require('xtend')
    opts = xtend({
        path: tmpDir.name, // directory to use for storing BLAST db
    }, opts || {})
    var blastDB = blastLevel(db, opts)

    db.put('foo', {
        seq: "GATTACACATTACA",
        updated: 1
    }, function(err) {
        t.pass("added foo, building blast index")
        blastDB.rebuild(function(err) {
            if(err) t.fail("mysterious failure W: " + err)
            db.put('bar', {
                seq: "CATCATCATATTACACATTACCATCATCAT",
                updated: 1
            }, function(err) {
                t.pass("added bar, rebuilding blast index")
                blastDB.rebuild(function(err) {
                    if(err) t.fail("mysterious failure X: " + err)
                    blastDB.query("ATTACACATTAC", function(err, data) {
                        if(err) t.fail("mysterious failure Y: " + err)
                        cb(data)
                    }, function(err) {
                        if(err) t.fail("mysterious failure Z: " + err)
                        t.pass("end of results")
                    })
                })
            })
        })
    })
}
